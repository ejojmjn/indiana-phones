---
- hosts: 127.0.0.1
  connection: local
  become: yes
  vars:

  tasks:

  - debug: { msg: "{{ ansible_architecture }}" }
  - debug: { msg: "{{ ansible_os_family }}" }





  - name: Install InfluxDB
    block:
      - name: Add InfluxDB repo 
        apt_repository:
          repo: deb https://repos.influxdata.com/debian stretch stable
          state: present
      - name: Update APT cache
        apt:
          update_cache: yes
      - name: Install InfluxDB
        apt:
          name: influxdb
        environment:
          RUNLEVEL: 1

  - name: Install Telegraph telemetry agent
    block:
      - name: Download and install Telegraph from .deb
        apt:
          deb: https://dl.influxdata.com/telegraf/releases/telegraf_1.9.0-1_amd64.deb
        environment:
          RUNLEVEL: 1
        when: ansible_architecture == "x86_64"
      - name: Install Telegraph for ARM from tarball
        unarchive:
          src: https://dl.influxdata.com/influxdb/releases/influxdb-1.7.1_linux_armhf.tar.gz
          dest: /
          remote_src: yes
          extra_opts: [--strip-components=1]
        when: ansible_architecture == "armv7l"
